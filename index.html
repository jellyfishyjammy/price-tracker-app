<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Tracker (Supabase 雲端版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-blue-50 min-h-screen text-slate-800 p-4 md:p-8">

    <div id="loginScreen" class="max-w-md mx-auto mt-20 glass-panel rounded-2xl shadow-xl p-8">
        
        <div id="authSection">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-slate-900 mb-2">Price Tracker</h1>
                <p class="text-slate-500">登入或註冊您的專屬雲端比價庫</p>
            </div>
            <form id="authForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">電子信箱</label>
                    <input type="email" id="emailInput" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">密碼 (至少 6 碼)</label>
                    <input type="password" id="passwordInput" required minlength="6" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="text-right mt-1">
                    <button type="button" id="btnShowForgot" class="text-sm text-blue-600 hover:text-blue-800 transition-colors">忘記密碼？</button>
                </div>
                
                <div id="authError" class="text-red-500 text-sm hidden"></div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" id="btnLogin" class="flex-1 bg-slate-900 hover:bg-slate-800 text-white py-2.5 rounded-lg transition-colors shadow-sm">登入</button>
                    <button type="button" id="btnRegister" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg transition-colors shadow-sm">註冊</button>
                </div>
            </form>
        </div>

        <div id="forgotSection" class="hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900 mb-2">重設密碼</h2>
                <p class="text-sm text-slate-500">請輸入註冊信箱，我們將發送重設連結。</p>
            </div>
            <form class="space-y-4">
                <div>
                    <input type="email" id="forgotEmailInput" required placeholder="您的電子信箱" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div id="forgotMsg" class="text-sm hidden"></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" id="btnBackToLogin" class="flex-1 border border-slate-300 text-slate-700 hover:bg-slate-50 py-2.5 rounded-lg transition-colors">返回</button>
                    <button type="button" id="btnSendReset" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg transition-colors shadow-sm">發送連結</button>
                </div>
            </form>
        </div>

        <div id="updatePwdSection" class="hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900 mb-2">設定新密碼</h2>
                <p class="text-sm text-slate-500">歡迎回來！請輸入您的新密碼。</p>
            </div>
            <form class="space-y-4">
                <div>
                    <input type="password" id="newPasswordInput" required minlength="6" placeholder="新密碼 (至少 6 碼)" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div id="updateMsg" class="text-sm hidden"></div>
                <button type="button" id="btnUpdatePwd" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg transition-colors shadow-sm">確認修改並登入</button>
            </form>
        </div>
    </div>

    <div id="appScreen" class="max-w-6xl mx-auto hidden">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900 tracking-tight">Price Tracker</h1>
                <p class="text-slate-500 text-sm mt-1" id="userGreeting">載入中...</p>
            </div>
            <button id="btnLogout" class="text-sm text-slate-500 hover:text-red-500 font-medium transition-colors">登出</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-5 glass-panel rounded-2xl shadow-xl p-6 md:p-8 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-teal-400"></div>
                <h2 class="text-2xl font-semibold mb-6 text-slate-800">輸入商品資訊</h2>
                
                <form id="priceForm" class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">商品名稱</label>
                        <input list="nameList" id="itemName" required placeholder="例如：鮮乳、衛生紙..." class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                        <datalist id="nameList"></datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">品牌</label>
                        <input list="brandList" id="itemBrand" required placeholder="例如：瑞穗、舒潔..." class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                        <datalist id="brandList"></datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">規格 (容量/重量/數量)</label>
                        <div class="flex gap-2">
                            <input type="number" id="itemQty" step="0.01" required placeholder="數值" class="w-2/3 px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                            <select id="itemUnit" class="w-1/3 px-4 py-2.5 rounded-lg border border-slate-300 bg-white outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="g">公克 (g)</option><option value="kg">公斤 (kg)</option>
                                <option value="ml">毫升 (ml)</option><option value="L">公升 (L)</option>
                                <option value="pcs">件/抽 (pcs)</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">購買價格</label>
                        <div class="flex gap-2">
                            <input type="number" id="itemPrice" step="0.01" required placeholder="總價" class="w-2/3 px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                            <select id="itemCurrency" class="w-1/3 px-4 py-2.5 rounded-lg border border-slate-300 bg-white outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="TWD">台幣 (TWD)</option><option value="USD">美金 (USD)</option><option value="JPY">日幣 (JPY)</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">購買日期</label>
                        <input type="date" id="itemDate" required class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <button type="submit" class="w-full mt-4 bg-slate-900 hover:bg-slate-800 text-white font-medium py-3 px-4 rounded-lg shadow-md transition-colors">
                        分析並比對歷史價格
                    </button>
                </form>
            </div>

            <div class="lg:col-span-7 flex flex-col gap-6">
                <div id="emptyState" class="glass-panel rounded-2xl p-10 flex flex-col items-center justify-center text-center h-full border-dashed border-2 border-slate-300">
                    <p class="text-slate-500 text-lg">載入完成。請在左側輸入商品進行分析。</p>
                </div>

                <div id="resultsArea" class="hidden flex flex-col gap-6">
                    <div class="glass-panel rounded-2xl shadow-xl p-6">
                        <h3 class="text-sm font-bold text-blue-600 uppercase tracking-wider mb-2">本次單價分析</h3>
                        <p id="resNameBrand" class="text-xl font-semibold text-slate-800"></p>
                        <p id="resUnitPrice" class="text-3xl font-bold text-slate-900 mt-2"></p>
                    </div>
                    <div class="glass-panel rounded-2xl shadow-xl p-6 border-l-4" id="reportCard">
                        <div id="reportContent" class="space-y-4 text-slate-700"></div>
                    </div>
                    <div class="flex gap-4">
                        <button id="btnSave" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">加入雲端紀錄</button>
                        <button id="btnNew" class="flex-1 bg-white border border-slate-200 text-slate-700 font-medium py-3 px-4 rounded-lg transition-colors">建立新查詢</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ⚠️⚠️⚠️ 貼上你在 Supabase 後台拿到的 URL 和 API Key ⚠️⚠️⚠️
        const SUPABASE_URL = 'https://fugdnxzywuypxfsetsmo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1Z2RueHp5d3V5cHhmc2V0c21vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MDI1NTMsImV4cCI6MjA4NzI3ODU1M30.L6ON4ZcBM_3eqbQve4S8BJBpyzfAH4KtHw6EfgtCoF8';
        // ==========================================

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;
        let userHistory = [];
        let currentAnalyzedItem = null;
        let isRecoveringPassword = false; // 追蹤是否在重設密碼流程中

        document.getElementById('itemDate').valueAsDate = new Date();

        // ------------------------------------------
        // 面板切換與驗證邏輯
        // ------------------------------------------
        function showAuthSection() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('forgotSection').classList.add('hidden');
            document.getElementById('updatePwdSection').classList.add('hidden');
        }

        function showForgotSection() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('forgotSection').classList.remove('hidden');
            document.getElementById('updatePwdSection').classList.add('hidden');
        }

        function showUpdatePwdSection() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('forgotSection').classList.add('hidden');
            document.getElementById('updatePwdSection').classList.remove('hidden');
        }

        async function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('userGreeting').textContent = `登入帳號：${currentUser.email}`;
            await loadCloudHistory();
        }

        // 監聽所有身分驗證事件 (包含登入、登出、以及密碼重設)
        supabase.auth.onAuthStateChanged(async (event, session) => {
            if (event === 'PASSWORD_RECOVERY') {
                // 當使用者點擊 Email 裡的重設連結時，Supabase 會觸發這個事件
                isRecoveringPassword = true;
                showUpdatePwdSection();
            } else if (session && !isRecoveringPassword) {
                // 正常登入
                currentUser = session.user;
                showApp();
            } else if (!session) {
                // 尚未登入
                currentUser = null;
                showAuthSection();
            }
        });

        // ------------------------------------------
        // 登入、註冊、登出 按鈕
        // ------------------------------------------
        document.getElementById('btnLogin').addEventListener('click', async () => {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('authError');
            
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                errorDiv.textContent = '登入失敗：' + error.message;
                errorDiv.classList.remove('hidden');
            }
        });

        document.getElementById('btnRegister').addEventListener('click', async () => {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('authError');
            
            const { error } = await supabase.auth.signUp({ email, password });
            if (error) {
                errorDiv.textContent = '註冊失敗：' + error.message;
                errorDiv.classList.remove('hidden');
            } else {
                alert('註冊成功！為您自動登入。');
            }
        });

        document.getElementById('btnLogout').addEventListener('click', async () => {
            await supabase.auth.signOut();
        });

        // ------------------------------------------
        // 忘記密碼 / 重設密碼邏輯
        // ------------------------------------------
        document.getElementById('btnShowForgot').addEventListener('click', showForgotSection);
        document.getElementById('btnBackToLogin').addEventListener('click', showAuthSection);

        // 步驟 1: 發送重設信件
        document.getElementById('btnSendReset').addEventListener('click', async () => {
            const email = document.getElementById('forgotEmailInput').value;
            const msgDiv = document.getElementById('forgotMsg');
            const btn = document.getElementById('btnSendReset');
            
            if (!email) {
                msgDiv.className = "text-sm text-red-500 mt-2";
                msgDiv.textContent = "請輸入電子信箱";
                msgDiv.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            btn.textContent = "發送中...";

            // 使用目前的網址作為回傳點，確保回到你的 GitHub Pages
            const redirectUrl = window.location.origin + window.location.pathname;

            const { error } = await supabase.auth.resetPasswordForEmail(email, {
                redirectTo: redirectUrl,
            });

            msgDiv.classList.remove('hidden');
            if (error) {
                msgDiv.className = "text-sm text-red-500 mt-2";
                msgDiv.textContent = "發送失敗：" + error.message;
            } else {
                msgDiv.className = "text-sm text-green-600 font-medium mt-2";
                msgDiv.textContent = "✅ 重設信件已發送！請去信箱點擊連結。";
            }
            
            btn.disabled = false;
            btn.textContent = "發送連結";
        });

        // 步驟 2: 設定新密碼並登入
        document.getElementById('btnUpdatePwd').addEventListener('click', async () => {
            const newPassword = document.getElementById('newPasswordInput').value;
            const msgDiv = document.getElementById('updateMsg');
            const btn = document.getElementById('btnUpdatePwd');
            
            if (newPassword.length < 6) {
                msgDiv.className = "text-sm text-red-500 mt-2";
                msgDiv.textContent = "密碼至少需要 6 碼";
                msgDiv.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            btn.textContent = "更新中...";

            // 更新密碼
            const { error } = await supabase.auth.updateUser({
                password: newPassword
            });

            msgDiv.classList.remove('hidden');
            if (error) {
                msgDiv.className = "text-sm text-red-500 mt-2";
                msgDiv.textContent = "更新失敗：" + error.message;
                btn.disabled = false;
                btn.textContent = "確認修改並登入";
            } else {
                msgDiv.className = "text-sm text-green-600 font-medium mt-2";
                msgDiv.textContent = "✅ 密碼修改成功！正在進入系統...";
                isRecoveringPassword = false; // 解除密碼重設狀態
                
                setTimeout(() => {
                    showApp();
                }, 1500);
            }
        });

        // ------------------------------------------
        // App 核心邏輯 (讀取/分析/儲存)
        // ------------------------------------------
        async function loadCloudHistory() {
            document.getElementById('emptyState').innerHTML = '<p class="text-slate-500">正在從雲端同步您的資料...</p>';
            const { data, error } = await supabase.from('purchases').select('*').order('created_at', { ascending: false });
            
            if (error) {
                console.error(error);
                document.getElementById('emptyState').innerHTML = '<p class="text-red-500">讀取失敗，請重新整理頁面。</p>';
                return;
            }
            userHistory = data || [];
            populateDatalists();
            document.getElementById('emptyState').innerHTML = '<p class="text-slate-500">同步完成。請在左側輸入商品進行分析。</p>';
        }

        function populateDatalists() {
            const names = [...new Set(userHistory.map(item => item.name))];
            const brands = [...new Set(userHistory.map(item => item.brand))];
            document.getElementById('nameList').innerHTML = names.map(n => `<option value="${n}">`).join('');
            document.getElementById('brandList').innerHTML = brands.map(b => `<option value="${b}">`).join('');
        }

        function getStandardizedData(qty, unit, price) {
            let sQty = parseFloat(qty);
            let sUnit = unit;
            if (unit === 'kg') { sQty = sQty * 1000; sUnit = 'g'; }
            if (unit === 'L') { sQty = sQty * 1000; sUnit = 'ml'; }
            return { sQty, sUnit, unitPrice: parseFloat((price / sQty).toFixed(4)) };
        }

        document.getElementById('priceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const stdData = getStandardizedData(
                document.getElementById('itemQty').value,
                document.getElementById('itemUnit').value,
                document.getElementById('itemPrice').value
            );
            
            currentAnalyzedItem = {
                user_id: currentUser.id,
                name: document.getElementById('itemName').value.trim(),
                brand: document.getElementById('itemBrand').value.trim(),
                qty: parseFloat(document.getElementById('itemQty').value),
                unit: document.getElementById('itemUnit').value,
                price: parseFloat(document.getElementById('itemPrice').value),
                currency: document.getElementById('itemCurrency').value,
                date: document.getElementById('itemDate').value,
                std_qty: stdData.sQty,
                std_unit: stdData.sUnit,
                unit_price: stdData.unitPrice
            };
            generateReport(currentAnalyzedItem);
        });

        function generateReport(currentItem) {
            const relevantHistory = userHistory.filter(h => 
                h.name === currentItem.name && h.brand === currentItem.brand && h.std_unit === currentItem.std_unit && h.currency === currentItem.currency
            );

            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultsArea').classList.remove('hidden');
            document.getElementById('resNameBrand').textContent = `${currentItem.brand} ${currentItem.name}`;
            document.getElementById('resUnitPrice').textContent = `${currentItem.unit_price} ${currentItem.currency}/${currentItem.std_unit}`;

            const reportContent = document.getElementById('reportContent');
            const reportCard = document.getElementById('reportCard');

            if (relevantHistory.length === 0) {
                reportCard.className = "glass-panel rounded-2xl shadow-xl p-6 border-l-4 border-slate-400";
                reportContent.innerHTML = `<p>這是您第一次記錄此商品。建議直接購買並存檔，下次就能比價！</p>`;
            } else {
                const prices = relevantHistory.map(h => h.unit_price);
                const avgPrice = (prices.reduce((a,b) => a+b, 0) / prices.length).toFixed(4);
                
                if (currentItem.unit_price < avgPrice) {
                    reportCard.className = "glass-panel rounded-2xl shadow-xl p-6 border-l-4 border-green-500";
                    reportContent.innerHTML = `<p class="font-bold text-green-700 mb-2">✅ 強烈推薦購買</p><p>比歷史平均便宜！</p><p class="text-sm mt-2">歷史平均: ${avgPrice} ${currentItem.currency}/${currentItem.std_unit}</p>`;
                } else {
                    reportCard.className = "glass-panel rounded-2xl shadow-xl p-6 border-l-4 border-red-500";
                    reportContent.innerHTML = `<p class="font-bold text-red-700 mb-2">⚠️ 買貴了</p><p>比歷史平均貴，建議觀望。</p><p class="text-sm mt-2">歷史平均: ${avgPrice} ${currentItem.currency}/${currentItem.std_unit}</p>`;
                }
            }
        }

        document.getElementById('btnSave').addEventListener('click', async function() {
            if (!currentAnalyzedItem) return;
            const btn = this;
            btn.disabled = true;
            btn.textContent = "上傳中...";

            const { data, error } = await supabase.from('purchases').insert([currentAnalyzedItem]).select();

            if (error) {
                console.error(error);
                alert("儲存失敗：" + error.message);
                btn.disabled = false;
                btn.textContent = "加入雲端紀錄";
            } else {
                userHistory.unshift(data[0]); // 加到陣列最前面
                populateDatalists();
                btn.textContent = "已存入雲端！";
                btn.classList.replace('bg-blue-600', 'bg-green-600');
            }
        });

        document.getElementById('btnNew').addEventListener('click', function() {
            document.getElementById('priceForm').reset();
            document.getElementById('itemDate').valueAsDate = new Date();
            currentAnalyzedItem = null;
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('resultsArea').classList.add('hidden');
            const btnSave = document.getElementById('btnSave');
            btnSave.disabled = false;
            btnSave.textContent = "加入雲端紀錄";
            btnSave.classList.replace('bg-green-600', 'bg-blue-600');
        });

    </script>
</body>
</html>
