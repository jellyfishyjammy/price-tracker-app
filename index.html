<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Tracker (Supabase é›²ç«¯ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-blue-50 min-h-screen text-slate-800 p-4 md:p-8">

    <div id="loginScreen" class="max-w-md mx-auto mt-20 glass-panel rounded-2xl shadow-xl p-8">
        
        <div id="authSection">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-slate-900 mb-2">Price Tracker</h1>
                <p class="text-slate-500">ç™»å…¥æˆ–è¨»å†Šæ‚¨çš„å°ˆå±¬é›²ç«¯æ¯”åƒ¹åº«</p>
            </div>
            <form id="authForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">é›»å­ä¿¡ç®±</label>
                    <input type="email" id="emailInput" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">å¯†ç¢¼ (è‡³å°‘ 6 ç¢¼)</label>
                    <input type="password" id="passwordInput" required minlength="6" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="text-right mt-1">
                    <button type="button" id="btnShowForgot" class="text-sm text-blue-600 hover:text-blue-800 transition-colors">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</button>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" id="btnLogin" class="flex-1 bg-slate-900 hover:bg-slate-800 text-white py-2.5 rounded-lg transition-colors shadow-sm">ç™»å…¥</button>
                    <button type="button" id="btnRegister" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg transition-colors shadow-sm">è¨»å†Š</button>
                </div>
            </form>
        </div>

        <div id="forgotSection" class="hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900 mb-2">é‡è¨­å¯†ç¢¼</h2>
                <p class="text-sm text-slate-500">è«‹è¼¸å…¥è¨»å†Šä¿¡ç®±ï¼Œæˆ‘å€‘å°‡ç™¼é€é‡è¨­é€£çµã€‚</p>
            </div>
            <form class="space-y-4">
                <div>
                    <input type="email" id="forgotEmailInput" required placeholder="æ‚¨çš„é›»å­ä¿¡ç®±" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" id="btnBackToLogin" class="flex-1 border border-slate-300 text-slate-700 hover:bg-slate-50 py-2.5 rounded-lg transition-colors">è¿”å›</button>
                    <button type="button" id="btnSendReset" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg transition-colors shadow-sm">ç™¼é€é€£çµ</button>
                </div>
            </form>
        </div>

        <div id="updatePwdSection" class="hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900 mb-2">è¨­å®šæ–°å¯†ç¢¼</h2>
                <p class="text-sm text-slate-500">æ­¡è¿å›ä¾†ï¼è«‹è¼¸å…¥æ‚¨çš„æ–°å¯†ç¢¼ã€‚</p>
            </div>
            <form class="space-y-4">
                <div>
                    <input type="password" id="newPasswordInput" required minlength="6" placeholder="æ–°å¯†ç¢¼ (è‡³å°‘ 6 ç¢¼)" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <button type="button" id="btnUpdatePwd" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg transition-colors shadow-sm">ç¢ºèªä¿®æ”¹ä¸¦ç™»å…¥</button>
            </form>
        </div>
    </div>

    <div id="appScreen" class="max-w-6xl mx-auto hidden">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900 tracking-tight">Price Tracker</h1>
                <p class="text-slate-500 text-sm mt-1" id="userGreeting">è¼‰å…¥ä¸­...</p>
            </div>
            <button id="btnLogout" class="text-sm text-slate-500 hover:text-red-500 font-medium transition-colors">ç™»å‡º</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-5 glass-panel rounded-2xl shadow-xl p-6 md:p-8 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-teal-400"></div>
                <h2 class="text-2xl font-semibold mb-6 text-slate-800">è¼¸å…¥å•†å“è³‡è¨Š</h2>
                
                <form id="priceForm" class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">å•†å“åç¨±</label>
                        <input list="nameList" id="itemName" required class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                        <datalist id="nameList"></datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">å“ç‰Œ</label>
                        <input list="brandList" id="itemBrand" required class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                        <datalist id="brandList"></datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">è¦æ ¼ (å®¹é‡/é‡é‡/æ•¸é‡)</label>
                        <div class="flex gap-2">
                            <input type="number" id="itemQty" step="0.01" required class="w-2/3 px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                            <select id="itemUnit" class="w-1/3 px-4 py-2.5 rounded-lg border border-slate-300 bg-white outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="g">å…¬å…‹ (g)</option><option value="kg">å…¬æ–¤ (kg)</option>
                                <option value="ml">æ¯«å‡ (ml)</option><option value="L">å…¬å‡ (L)</option>
                                <option value="pcs">ä»¶/æŠ½ (pcs)</option>
                             </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">è³¼è²·åƒ¹æ ¼</label>
                        <div class="flex gap-2">
                            <input type="number" id="itemPrice" step="0.01" required class="w-2/3 px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                            <select id="itemCurrency" class="w-1/3 px-4 py-2.5 rounded-lg border border-slate-300 bg-white outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="TWD">å°å¹£ (TWD)</option><option value="USD">ç¾é‡‘ (USD)</option><option value="JPY">æ—¥å¹£ (JPY)</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">è³¼è²·æ—¥æœŸ</label>
                        <input type="date" id="itemDate" required class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <button type="submit" class="w-full mt-4 bg-slate-900 hover:bg-slate-800 text-white font-medium py-3 px-4 rounded-lg shadow-md transition-colors">
                        åˆ†æä¸¦æ¯”å°æ­·å²åƒ¹æ ¼
                    </button>
                </form>
            </div>

            <div class="lg:col-span-7 flex flex-col gap-6">
                <div id="emptyState" class="glass-panel rounded-2xl p-10 flex flex-col items-center justify-center text-center h-full border-dashed border-2 border-slate-300">
                    <p class="text-slate-500 text-lg">è«‹åœ¨å·¦å´è¼¸å…¥å•†å“é€²è¡Œåˆ†æã€‚</p>
                </div>
                <div id="resultsArea" class="hidden flex flex-col gap-6">
                    <div class="glass-panel rounded-2xl shadow-xl p-6 border-l-4" id="reportCard">
                        <div id="reportContent" class="space-y-4 text-slate-700"></div>
                    </div>
                    <div class="flex gap-4">
                        <button id="btnSave" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">åŠ å…¥é›²ç«¯ç´€éŒ„</button>
                        <button id="btnNew" class="flex-1 bg-white border border-slate-200 text-slate-700 font-medium py-3 px-4 rounded-lg transition-colors">å»ºç«‹æ–°æŸ¥è©¢</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€éŒ¯èª¤æ•æ‰ (å¦‚æœç¨‹å¼æ­»æ©Ÿï¼Œæœƒå¼·åˆ¶è·³è­¦å‘Š)
        window.onerror = function(msg, url, line) {
            alert("ç¶²é ç™¼ç”Ÿåš´é‡éŒ¯èª¤ï¼š" + msg + "\n(è«‹æª¢æŸ¥ç¶²è·¯æˆ– F12 Console)");
        };

        const SUPABASE_URL = 'https://fugdnxzywuypxfsetsmo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1Z2RueHp5d3V5cHhmc2V0c21vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MDI1NTMsImV4cCI6MjA4NzI3ODU1M30.L6ON4ZcBM_3eqbQve4S8BJBpyzfAH4KtHw6EfgtCoF8';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let userHistory = [];
        let currentAnalyzedItem = null;
        let isRecoveringPassword = false;

        document.getElementById('itemDate').valueAsDate = new Date();

        function showAuthSection() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('forgotSection').classList.add('hidden');
            document.getElementById('updatePwdSection').classList.add('hidden');
        }

        function showForgotSection() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('forgotSection').classList.remove('hidden');
            document.getElementById('updatePwdSection').classList.add('hidden');
        }

        function showUpdatePwdSection() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('forgotSection').classList.add('hidden');
            document.getElementById('updatePwdSection').classList.remove('hidden');
        }

        async function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('userGreeting').textContent = `å¸³è™Ÿï¼š${currentUser.email}`;
            await loadCloudHistory();
        }

        supabase.auth.onAuthStateChanged(async (event, session) => {
            if (event === 'PASSWORD_RECOVERY') {
                isRecoveringPassword = true;
                showUpdatePwdSection();
            } else if (session && !isRecoveringPassword) {
                currentUser = session.user;
                showApp();
            } else if (!session) {
                currentUser = null;
                showAuthSection();
            }
        });

        // ==========================================
        // ğŸš¨ æ”¹è‰¯ç‰ˆçš„è¨»å†Šèˆ‡ç™»å…¥ (å¼·åˆ¶ Alert é¡¯ç¤ºéŒ¯èª¤)
        // ==========================================
        document.getElementById('btnRegister').addEventListener('click', async () => {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;

            if (!email || !email.includes('@')) {
                alert("âŒ è«‹è¼¸å…¥æ­£ç¢ºçš„é›»å­ä¿¡ç®±ï¼");
                return;
            }
            if (password.length < 6) {
                alert("âŒ å¯†ç¢¼å¤ªçŸ­ï¼Œè«‹è‡³å°‘è¼¸å…¥ 6 å€‹å­—å…ƒï¼");
                return;
            }

            const btn = document.getElementById('btnRegister');
            btn.textContent = "è™•ç†ä¸­...";
            btn.disabled = true;

            try {
                const { data, error } = await supabase.auth.signUp({ email, password });
                if (error) {
                    alert("è¨»å†Šå¤±æ•—ï¼š" + error.message);
                } else {
                    alert("ğŸ‰ è¨»å†ŠæˆåŠŸï¼ç³»çµ±å·²ç‚ºæ‚¨ç™»å…¥ã€‚");
                }
            } catch (err) {
                alert("ç™¼ç”Ÿç¶²è·¯æˆ–ç³»çµ±ç•°å¸¸ï¼š" + err.message);
            } finally {
                btn.textContent = "è¨»å†Š";
                btn.disabled = false;
            }
        });

        document.getElementById('btnLogin').addEventListener('click', async () => {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;

            if (!email || !password) {
                alert("âŒ è«‹å®Œæ•´è¼¸å…¥ä¿¡ç®±èˆ‡å¯†ç¢¼ï¼");
                return;
            }

            const btn = document.getElementById('btnLogin');
            btn.textContent = "ç™»å…¥ä¸­...";
            btn.disabled = true;

            try {
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) {
                    alert("ç™»å…¥å¤±æ•—ï¼š" + error.message);
                }
            } catch (err) {
                alert("ç™¼ç”Ÿç¶²è·¯æˆ–ç³»çµ±ç•°å¸¸ï¼š" + err.message);
            } finally {
                btn.textContent = "ç™»å…¥";
                btn.disabled = false;
            }
        });

        document.getElementById('btnLogout').addEventListener('click', async () => {
            await supabase.auth.signOut();
        });

        document.getElementById('btnShowForgot').addEventListener('click', showForgotSection);
        document.getElementById('btnBackToLogin').addEventListener('click', showAuthSection);

        document.getElementById('btnSendReset').addEventListener('click', async () => {
            const email = document.getElementById('forgotEmailInput').value;
            if (!email) {
                alert("âŒ è«‹è¼¸å…¥é›»å­ä¿¡ç®±ï¼"); return;
            }
            
            document.getElementById('btnSendReset').textContent = "ç™¼é€ä¸­...";
            const redirectUrl = window.location.origin + window.location.pathname;
            
            try {
                const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: redirectUrl });
                if (error) {
                    alert("ç™¼é€å¤±æ•—ï¼š" + error.message);
                } else {
                    alert("âœ… é‡è¨­ä¿¡ä»¶å·²ç™¼é€ï¼è«‹å»ä¿¡ç®±é»æ“Šé€£çµã€‚");
                }
            } catch(err) {
                alert("ç³»çµ±ç•°å¸¸ï¼š" + err.message);
            } finally {
                document.getElementById('btnSendReset').textContent = "ç™¼é€é€£çµ";
            }
        });

        document.getElementById('btnUpdatePwd').addEventListener('click', async () => {
            const newPassword = document.getElementById('newPasswordInput').value;
            if (newPassword.length < 6) {
                alert("âŒ å¯†ç¢¼è‡³å°‘éœ€è¦ 6 ç¢¼ï¼"); return;
            }
            document.getElementById('btnUpdatePwd').textContent = "æ›´æ–°ä¸­...";
            try {
                const { error } = await supabase.auth.updateUser({ password: newPassword });
                if (error) {
                    alert("æ›´æ–°å¤±æ•—ï¼š" + error.message);
                } else {
                    alert("âœ… å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼æ­£åœ¨é€²å…¥ç³»çµ±...");
                    isRecoveringPassword = false;
                    setTimeout(() => showApp(), 1500);
                }
            } catch(err) {
                alert("ç³»çµ±ç•°å¸¸ï¼š" + err.message);
            } finally {
                document.getElementById('btnUpdatePwd').textContent = "ç¢ºèªä¿®æ”¹ä¸¦ç™»å…¥";
            }
        });

        async function loadCloudHistory() {
            const { data, error } = await supabase.from('purchases').select('*').order('created_at', { ascending: false });
            if (!error) {
                userHistory = data || [];
                populateDatalists();
            }
        }

        function populateDatalists() {
            const names = [...new Set(userHistory.map(item => item.name))];
            const brands = [...new Set(userHistory.map(item => item.brand))];
            document.getElementById('nameList').innerHTML = names.map(n => `<option value="${n}">`).join('');
            document.getElementById('brandList').innerHTML = brands.map(b => `<option value="${b}">`).join('');
        }

        function getStandardizedData(qty, unit, price) {
            let sQty = parseFloat(qty);
            let sUnit = unit;
            if (unit === 'kg') { sQty = sQty * 1000; sUnit = 'g'; }
            if (unit === 'L') { sQty = sQty * 1000; sUnit = 'ml'; }
            return { sQty, sUnit, unitPrice: parseFloat((price / sQty).toFixed(4)) };
        }

        document.getElementById('priceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const stdData = getStandardizedData(
                document.getElementById('itemQty').value,
                document.getElementById('itemUnit').value,
                document.getElementById('itemPrice').value
            );
            
            currentAnalyzedItem = {
                user_id: currentUser.id,
                name: document.getElementById('itemName').value.trim(),
                brand: document.getElementById('itemBrand').value.trim(),
                qty: parseFloat(document.getElementById('itemQty').value),
                unit: document.getElementById('itemUnit').value,
                price: parseFloat(document.getElementById('itemPrice').value),
                currency: document.getElementById('itemCurrency').value,
                date: document.getElementById('itemDate').value,
                std_qty: stdData.sQty,
                std_unit: stdData.sUnit,
                unit_price: stdData.unitPrice
            };
            generateReport(currentAnalyzedItem);
        });

        function generateReport(currentItem) {
            const relevantHistory = userHistory.filter(h => 
                h.name === currentItem.name && h.brand === currentItem.brand && h.std_unit === currentItem.std_unit && h.currency === currentItem.currency
            );
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultsArea').classList.remove('hidden');
            const reportCard = document.getElementById('reportCard');
            const reportContent = document.getElementById('reportContent');

            if (relevantHistory.length === 0) {
                reportCard.className = "glass-panel rounded-2xl shadow-xl p-6 border-l-4 border-slate-400";
                reportContent.innerHTML = `<p>é€™æ˜¯æ‚¨ç¬¬ä¸€æ¬¡è¨˜éŒ„ <strong>${currentItem.brand} ${currentItem.name}</strong>ã€‚å»ºè­°è³¼è²·ä¸¦å­˜æª”ï¼Œä¸‹æ¬¡å°±èƒ½æ¯”åƒ¹ï¼</p>`;
            } else {
                const prices = relevantHistory.map(h => h.unit_price);
                const avgPrice = (prices.reduce((a,b) => a+b, 0) / prices.length).toFixed(4);
                
                if (currentItem.unit_price < avgPrice) {
                    reportCard.className = "glass-panel rounded-2xl shadow-xl p-6 border-l-4 border-green-500";
                    reportContent.innerHTML = `<p class="font-bold text-green-700 mb-2">âœ… å¼·çƒˆæ¨è–¦è³¼è²·</p><p>ç›®å‰å–®ä½åƒ¹ <strong>${currentItem.unit_price}</strong> æ¯”æ­·å²å¹³å‡ä¾¿å®œï¼</p><p class="text-sm mt-2 text-slate-500">æ­·å²å¹³å‡: ${avgPrice} ${currentItem.currency}/${currentItem.std_unit}</p>`;
                } else {
                    reportCard.className = "glass-panel rounded-2xl shadow-xl p-6 border-l-4 border-red-500";
                    reportContent.innerHTML = `<p class="font-bold text-red-700 mb-2">âš ï¸ è²·è²´äº†</p><p>ç›®å‰å–®ä½åƒ¹ <strong>${currentItem.unit_price}</strong> æ¯”æ­·å²å¹³å‡è²´ï¼Œå»ºè­°è§€æœ›ã€‚</p><p class="text-sm mt-2 text-slate-500">æ­·å²å¹³å‡: ${avgPrice} ${currentItem.currency}/${currentItem.std_unit}</p>`;
                }
            }
        }

        document.getElementById('btnSave').addEventListener('click', async function() {
            if (!currentAnalyzedItem) return;
            const btn = this;
            btn.disabled = true;
            btn.textContent = "ä¸Šå‚³ä¸­...";

            try {
                const { data, error } = await supabase.from('purchases').insert([currentAnalyzedItem]).select();
                if (error) {
                    alert("å„²å­˜å¤±æ•—ï¼š" + error.message);
                } else {
                    userHistory.unshift(data[0]);
                    populateDatalists();
                    alert("âœ… å·²æˆåŠŸå­˜å…¥é›²ç«¯ï¼");
                    btn.classList.replace('bg-blue-600', 'bg-green-600');
                }
            } catch(err) {
                alert("ç³»çµ±ç•°å¸¸ï¼š" + err.message);
            } finally {
                btn.textContent = "åŠ å…¥é›²ç«¯ç´€éŒ„";
                btn.disabled = false;
            }
        });

        document.getElementById('btnNew').addEventListener('click', function() {
            document.getElementById('priceForm').reset();
            document.getElementById('itemDate').valueAsDate = new Date();
            currentAnalyzedItem = null;
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('resultsArea').classList.add('hidden');
            const btnSave = document.getElementById('btnSave');
            btnSave.classList.replace('bg-green-600', 'bg-blue-600');
        });
    </script>
</body>
</html>
